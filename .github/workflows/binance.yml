name: Binance Daily Snapshot

# ให้ Actions เขียนไฟล์กลับ repo ได้
permissions:
  contents: write

on:
  # รันอัตโนมัติทุกวัน 14:00 เวลาไทย (UTC+7 = 07:00 UTC)
  schedule:
    - cron: '0 7 * * *'

  # กดรันเองได้
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # 1) Checkout repository
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # 2) Fetch Binance data (มี timeout กันค้าง)
      # -------------------------
      - name: Fetch Binance price & volume
        run: |
          echo "Fetching Binance data..."
          curl --max-time 20 -s https://api.binance.com/api/v3/ticker/24hr > snapshot_raw.json

          echo "Raw snapshot size:"
          wc -c snapshot_raw.json

      # -------------------------
      # 3) Build snapshot.json (กัน JSON พัง / ไม่ใช่ array)
      # -------------------------
      - name: Build snapshot.json
        run: |
          node -e "
          const fs = require('fs');

          const raw = fs.readFileSync('snapshot_raw.json', 'utf8');
          let data;

          try {
            data = JSON.parse(raw);
          } catch (e) {
            console.error('❌ Invalid JSON from Binance');
            console.error(raw.slice(0, 300));
            process.exit(1);
          }

          if (!Array.isArray(data)) {
            console.error('❌ Binance response is NOT an array');
            console.error(data);
            process.exit(1);
          }

          const coins = [
            'BTCUSDT','ETHUSDT','SOLUSDT','DOGEUSDT','ADAUSDT',
            'BNBUSDT','AVAXUSDT','XRPUSDT','SUIUSDT','XLMUSDT'
          ];

          const out = {
            timestamp_utc: new Date().toISOString(),
            source: 'binance',
            data: {}
          };

          data.forEach(x => {
            if (coins.includes(x.symbol)) {
              out.data[x.symbol] = {
                price: Number(x.lastPrice),
                volume: Number(x.volume)
              };
            }
          });

          fs.writeFileSync('snapshot.json', JSON.stringify(out, null, 2));
          console.log('✅ snapshot.json created');
          "

      # -------------------------
      # 4) Commit & push (มี timeout กันค้าง)
      # -------------------------
      - name: Commit snapshot
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add snapshot.json
          git commit -m "update binance daily snapshot" || echo "No changes to commit"

          # กัน git push ค้าง
          timeout 20 git push origin HEAD:main
